function normalizeLevel(lines){
  const src = lines.map(r => r.split(""));
  const H = src.length;
  const W = src[0].length;

  // S ve D yerleri (çakışma kontrolü için)
  const fixed = new Set();
  for(let y=0; y<H; y++){
    for(let x=0; x<W; x++){
      if(src[y][x] === "S" || src[y][x] === "D") fixed.add(`${x},${y}`);
    }
  }

  // İçerik olarak sayacağımız tile'lar:
  // - H A B kesin
  // - iç platformlar (#) ama sadece border olmayanlar
  const isContent = (ch, x, y) => {
    if(ch === "H" || ch === "A" || ch === "B") return true;
    if(ch === "#"){
      // border (#) sayma
      if(x===0 || y===0 || x===W-1 || y===H-1) return false;
      return true; // iç platform
    }
    return false;
  };

  // İçeriğin min/max Y'sini bul
  let minY = 999, maxY = -1;
  for(let y=1; y<H-1; y++){
    for(let x=1; x<W-1; x++){
      const ch = src[y][x];
      if(isContent(ch, x, y)){
        minY = Math.min(minY, y);
        maxY = Math.max(maxY, y);
      }
    }
  }

  // içerik yoksa dokunma
  if(maxY < 0) return lines;

  // İçerik aşağıda dursun ama zemine yapışmasın (H-3 iyi)
  const desiredMaxY = H - 3;
  let dy = desiredMaxY - maxY;

  // Yukarı taşma olmasın
  dy = Math.max(dy, 1 - minY);
  // Aşağı taşma olmasın (border üstüne)
  dy = Math.min(dy, (H - 2) - maxY);

  // Çakışma olursa dy'yi azalt
  const wouldCollide = (dyTry) => {
    for(let y=1; y<H-1; y++){
      for(let x=1; x<W-1; x++){
        const ch = src[y][x];
        if(!isContent(ch, x, y)) continue;
        const ny = y + dyTry;
        if(fixed.has(`${x},${ny}`)) return true;
      }
    }
    return false;
  };

  while(dy > 0 && wouldCollide(dy)) dy--;

  // Yeni grid: önce src'nin kopyasını al (S/D dahil kalsın)
  const out = src.map(r => r.slice());

  // İçerik tile'larını temizle (S/D ve border kalacak)
  for(let y=1; y<H-1; y++){
    for(let x=1; x<W-1; x++){
      if(isContent(out[y][x], x, y)) out[y][x] = ".";
    }
  }

  // İçeriği aşağı kaydırıp yerleştir (S/D üzerine yazma)
  for(let y=1; y<H-1; y++){
    for(let x=1; x<W-1; x++){
      const ch = src[y][x];
      if(!isContent(ch, x, y)) continue;
      const ny = y + dy;
      if(ny < 1 || ny > H-2) continue;
      if(out[ny][x] === "S" || out[ny][x] === "D") continue;
      out[ny][x] = ch;
    }
  }

  return out.map(r => r.join(""));
}
