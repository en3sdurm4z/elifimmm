<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Elifâ€™im â€” MinoÅŸ Kedi MacerasÄ± ğŸ§¸ğŸ’—</title>

  <style>
    :root{
      --text:#f5f2ff; --muted:#cfc6ea;
      --glass:#ffffff0a; --stroke:#ffffff14; --shadow:0 40px 160px #000000aa;
      --r:22px;
      --vh: 1vh; /* JS dolduracak */
    }
    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family: ui-rounded, system-ui, -apple-system, "Segoe UI", Arial;
      background: radial-gradient(1200px 700px at 10% -10%, #ff4d6d22, transparent 60%),
                  radial-gradient(900px 650px at 110% 10%, #7b2cff22, transparent 60%),
                  radial-gradient(900px 650px at 50% 120%, #00d4a122, transparent 60%),
                  linear-gradient(180deg, #07060c, #120b18);
      color:var(--text);

      /* âœ… mobil adres Ã§ubuÄŸu sorunu iÃ§in gerÃ§ek yÃ¼kseklik */
      min-height: calc(var(--vh) * 100);

      display:grid;
      place-items:center;
      padding: max(12px, env(safe-area-inset-top)) 12px max(12px, env(safe-area-inset-bottom));
      overflow:hidden;

      /* oyunda kaydÄ±rma istemiyoruz */
      touch-action: none;
    }

    .wrap{
      width:min(1100px, 98vw);
      background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;

      /* âœ… ekrana sÄ±ÄŸ */
      max-height: calc(var(--vh) * 100);
    }

    header{
      padding:14px 16px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      background:#0b0710cc;
      border-bottom:1px solid #ffffff10;
    }
    .brand{display:flex; gap:10px; align-items:center; min-width:0}
    .badge{
      width:36px; height:36px; border-radius:14px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, #ff4d6d, #7b2cff);
      border:1px solid #ffffff22;
      box-shadow:0 14px 34px #ff4d6d22;
      user-select:none;
      flex:0 0 auto;
    }
    .title{display:flex; flex-direction:column; gap:3px; min-width:0}
    .title b{font-size:14px; font-weight:950; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .title span{color:var(--muted); font-weight:800; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding:8px 10px; border-radius:999px;
      background:#ffffff0c; border:1px solid #ffffff14;
      color:#ffffffd0; font-weight:950; font-size:12px;
      white-space:nowrap;
      flex:0 0 auto;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 330px;
      gap:0;
    }
    @media (max-width: 950px){
      .row{grid-template-columns:1fr}
    }

    /* âœ… OYUN ALANI: her zaman 16:9 ve tek parÃ§a */
    .gameArea{
      position:relative;
      background:#05040a;
      border-right:1px solid #ffffff10;
      overflow:hidden;

      /* 16:9 sahne */
      aspect-ratio: 16 / 9;
    }
    @media (max-width: 950px){
      .gameArea{
        border-right:0;
        border-bottom:1px solid #ffffff10;

        /* mobilde Ã§ok uzamasÄ±n */
        max-height: min(56vh, 420px);
      }
    }

    /* âœ… canvas artÄ±k her zaman gameAreaâ€™yÄ± doldurur */
    canvas{
      display:block;
      width:100%;
      height:100%;
      background:#05040a;
    }

    aside{
      padding:14px;
      background:#0b07106e;
    }

    .box{
      background:#ffffff0a;
      border:1px solid #ffffff14;
      border-radius:18px;
      padding:12px;
      margin-bottom:12px;
    }
    .box h3{margin:0 0 8px; font-size:13px; font-weight:950}
    .box p{margin:0; color:#cfc6ea; font-weight:800; font-size:12.5px; line-height:1.45}

    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    button{
      appearance:none; border:0; cursor:pointer;
      color:#fff; font-weight:950;
      padding:10px 12px; border-radius:14px;
      background: linear-gradient(135deg, #ff4d6d, #ff7a9c);
      box-shadow:0 16px 42px #ff4d6d25;
      transition:.12s ease;
    }
    button:hover{transform:translateY(-1px); filter:brightness(1.05)}
    button:active{transform:translateY(1px)}
    .b2{background:linear-gradient(135deg, #7b2cff, #b08cff); box-shadow:0 16px 42px #7b2cff22}
    .b3{background:linear-gradient(135deg, #00d4a1, #7fffe0); color:#062015; box-shadow:0 16px 42px #00d4a122}
    .ghost{background:#ffffff10 !important; border:1px solid #ffffff18 !important; box-shadow:none !important}

    .mini{
      margin-top:10px;
      border-radius:16px;
      background:linear-gradient(135deg, #ffffff0f, #ff4d6d10);
      border:1px solid #ffffff14;
      padding:10px;
      color:#ffffffdd;
      font-weight:850;
      font-size:12.5px;
      line-height:1.35;
    }

    /* Touch controls */
    .touch{position:absolute; inset:0; pointer-events:none;}
    .pad{
      position:absolute; bottom:12px;
      display:flex; gap:10px; align-items:flex-end;
      pointer-events:auto; user-select:none;
    }
    .pad.left{left:12px}
    .pad.right{right:12px}
    .cluster{
      display:flex; gap:10px; align-items:flex-end;
      padding:10px;
      border-radius:18px;
      background:#00000055;
      border:1px solid #ffffff18;
      backdrop-filter: blur(10px);
    }
    .tbtn{
      width:58px; height:58px;
      border-radius:18px;
      border:1px solid #ffffff18;
      background:#ffffff10;
      color:#fff;
      font-weight:950;
      font-size:16px;
      display:grid; place-items:center;
      box-shadow: 0 18px 60px #00000055;
      touch-action:none;
    }
    .tbtn:active{transform:translateY(1px); filter:brightness(1.07)}
    .tbtn.main{background:linear-gradient(135deg, #ff4d6d55, #7b2cff55)}
    .hint{
      position:absolute; top:10px; left:10px; right:10px;
      text-align:center;
      color:#ffffffd0;
      font-weight:900;
      font-size:12px;
      text-shadow: 0 12px 28px #000;
      pointer-events:none;
      display:none;
    }
    @media (max-width: 950px){ .hint{display:block} }

    /* âœ… Fullscreen iken wrap komple ekrana otursun */
    .fs-on{
      width:100vw !important;
      height: calc(var(--vh) * 100) !important;
      max-height: calc(var(--vh) * 100) !important;
      border-radius:0 !important;
    }
    .fs-on .row{
      height: calc(var(--vh) * 100 - 62px);
      grid-template-columns: 1fr; /* fullscreen'de sadece oyun */
    }
    .fs-on aside{display:none;}
    .fs-on .gameArea{
      aspect-ratio:auto;
      height:100%;
      max-height:none;
      border:0;
    }
  </style>
</head>

<body>
  <div class="wrap" id="wrap">
    <header>
      <div class="brand">
        <div class="badge">ğŸ§¸</div>
        <div class="title">
          <b>Elifâ€™im iÃ§in: MinoÅŸ Kedi MacerasÄ± ğŸ’—</b>
          <span>Mobil: dokun â€¢ PC: â† â†’ + Space (basÄ±lÄ± tut zÄ±pla) â€¢ R: sÄ±fÄ±rla</span>
        </div>
      </div>
      <div class="pill">BÃ¶lÃ¼m <span id="lvl">1</span> â€¢ Kalp <span id="hearts">0</span>/<span id="need">0</span></div>
    </header>

    <div class="row">
      <div class="gameArea" id="gameArea">
        <div class="hint" id="hint">Ä°pucu: Kalpleri topla ğŸ’— â†’ kapÄ±ya git ğŸšª</div>
        <canvas id="c"></canvas>

        <div class="touch" aria-hidden="true">
          <div class="pad left">
            <div class="cluster">
              <button class="tbtn" id="left">â—€</button>
              <button class="tbtn" id="right">â–¶</button>
            </div>
          </div>
          <div class="pad right">
            <div class="cluster">
              <button class="tbtn main" id="jump">â¤’</button>
              <button class="tbtn" id="reset">R</button>
            </div>
          </div>
        </div>
      </div>

      <aside>
        <div class="box">
          <h3>ğŸ¯ NasÄ±l oynanÄ±r (net)</h3>
          <p>
            1) ğŸ’— Kalpleri topla <br/>
            2) ğŸšª KapÄ±ya git <br/>
            3) ğŸŸ© Asit = Ã¶lÃ¼rsÃ¼n (dikkat) <br/>
            4) ğŸŸ¨ ZÄ±plama taÅŸÄ± (B) = ekstra zÄ±plarsÄ±n
          </p>
          <div class="btns">
            <button class="b2" id="prev">â¬… Ã–nceki</button>
            <button id="next">Sonraki â¡</button>
            <button class="b3" id="restart">SÄ±fÄ±rla</button>
            <button class="ghost" id="fs">â›¶ Tam ekran</button>
          </div>
          <div class="mini" id="msg">Elifâ€™imâ€¦ ilk 2 bÃ¶lÃ¼m Ã§ok kolay. Sonra yavaÅŸ yavaÅŸ â€œmini engellerâ€ geliyor ğŸ˜„ğŸ’—</div>
        </div>

        <div class="box">
          <h3>âœ¨ Prod By</h3>
          <p>Prod By Enes Durmaz</p>
        </div>
      </aside>
    </div>
  </div>

<script>
(() => {
  // âœ… gerÃ§ek ekran yÃ¼ksekliÄŸi (iOS/Android adres Ã§ubuÄŸu fix)
  function setVH(){
    document.documentElement.style.setProperty("--vh", (window.innerHeight * 0.01) + "px");
  }
  setVH();
  window.addEventListener("resize", setVH, {passive:true});
  window.addEventListener("orientationchange", () => setTimeout(setVH, 250), {passive:true});

  const wrap = document.getElementById("wrap");
  const gameArea = document.getElementById("gameArea");

  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");

  const lvlEl = document.getElementById("lvl");
  const heartsEl = document.getElementById("hearts");
  const needEl = document.getElementById("need");
  const msgEl = document.getElementById("msg");
  const hintEl = document.getElementById("hint");

  // âœ… LOGICAL sahne boyutu (oyun fiziÄŸi bu Ã¶lÃ§ekte)
  const LOG_W = 960;
  const LOG_H = 540;

  // âœ… canvas'Ä± bulunduÄŸu kutuya tam oturt (PC + mobile)
  let DPR = 1;
  let SCALE = 1;

  function fitCanvas(){
    const rect = gameArea.getBoundingClientRect();
    const cssW = Math.max(1, Math.floor(rect.width));
    const cssH = Math.max(1, Math.floor(rect.height));

    DPR = Math.min(2, window.devicePixelRatio || 1);

    // gerÃ§ek px
    canvas.width  = Math.floor(cssW * DPR);
    canvas.height = Math.floor(cssH * DPR);

    // render scale (LOG -> css)
    SCALE = Math.min(cssW / LOG_W, cssH / LOG_H);

    // LOG Ã¶lÃ§ekte Ã§iz, ama ekrana SCALE ile bas
    ctx.setTransform(SCALE * DPR, 0, 0, SCALE * DPR, 0, 0);
  }

  window.addEventListener("resize", () => { setVH(); fitCanvas(); }, {passive:true});
  fitCanvas();

  const TILE = 30;
  const COLS = 32;
  const ROWS = 18;

  // tiles: # wall, . empty, S spawn, H heart, D door, A acid, B bounce
  const colors = {
    wall:"#2a2a33",
    acid:"#00d4a1",
    bounce:"#ffd166",
    door:"#ff4d6d",
    heart:"#ff4d6d",
  };

  const wallpapers = [
    ["#ff4d6d33","#7b2cff33","#00d4a133"],
    ["#ffd1dc33","#b08cff33","#7fffe033"],
    ["#ff9f1c33","#ff4d6d33","#7b2cff33"],
    ["#7fffe033","#00d4a133","#b08cff33"],
    ["#a0c4ff33","#ffc6ff33","#ffd6a533"],
    ["#caffbf33","#ffd6a533","#ffadad33"],
    ["#bde0fe33","#ffafcc33","#cdb4db33"],
    ["#f1c0e833","#cfbaf033","#a3c4f333"],
    ["#ffcad433","#bdb2ff33","#caffbf33"],
    ["#ffd16633","#ef476f33","#118ab233"],
  ];

  const messages = [
    "Elifâ€™imâ€¦ 1. bÃ¶lÃ¼m: sadece yÃ¼rÃ¼ + kalp + kapÄ± ğŸ˜„",
    "2. bÃ¶lÃ¼m: zÄ±plama var ama tatlÄ± tatlÄ± ğŸ’—",
    "3. bÃ¶lÃ¼m: asit geldi (yeÅŸil) dikkat minnoÅŸum ğŸ§¸",
    "4. bÃ¶lÃ¼m: asit Ã¼stÃ¼nden atlamayÄ± Ã¶ÄŸreniyoruz âœ¨",
    "5. bÃ¶lÃ¼m: B zÄ±plama taÅŸÄ± (sarÄ±) geldi ğŸ˜„",
    "6. bÃ¶lÃ¼m: B ile daha yÃ¼kseÄŸe Ã§Ä±kÄ±yoruz ğŸ’",
    "7. bÃ¶lÃ¼m: biraz kombinâ€¦ ama geÃ§ilir âœ…",
    "8. bÃ¶lÃ¼m: kalpleri sakladÄ±m, yine de adil ğŸ˜„",
    "9. bÃ¶lÃ¼m: minnoÅŸ refleks lazÄ±m ğŸ§¸",
    "10. bÃ¶lÃ¼m: mini final gibiâ€¦ ama kesin geÃ§ilir ğŸ’—",
  ];

  const LEVELS = [
    [
      "################################",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#.............H................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..S.......................D...#",
      "################################",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "################################",
    ],
    [
      "################################",
      "#..............................#",
      "#..............................#",
      "#.............H................#",
      "#...........######.............#",
      "#..............................#",
      "#.....................H........#",
      "#..................######......#",
      "#..............................#",
      "#..S.......................D...#",
      "################################",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "################################",
    ],
    [
      "################################",
      "#..............................#",
      "#..............................#",
      "#.............H................#",
      "#...........######.............#",
      "#..............................#",
      "#...........A A A A............#",
      "#..............................#",
      "#.....................H........#",
      "#..S.......................D...#",
      "################################",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "################################",
    ],
    [
      "################################",
      "#..............................#",
      "#........H.....................#",
      "#.......####...................#",
      "#..............................#",
      "#..........A A A...............#",
      "#..............................#",
      "#.....................H........#",
      "#..................####........#",
      "#..S.......................D...#",
      "################################",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "################################",
    ],
    [
      "################################",
      "#..............................#",
      "#..............H...............#",
      "#..............................#",
      "#..........B...................#",
      "#.........####.................#",
      "#..............................#",
      "#......................H.......#",
      "#....................####......#",
      "#..S.......................D...#",
      "################################",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "################################",
    ],
    [
      "################################",
      "#..............................#",
      "#..............H...............#",
      "#..............................#",
      "#....B........####.............#",
      "#..............................#",
      "#...........A A A..............#",
      "#..............................#",
      "#......................H.......#",
      "#..S.......................D...#",
      "################################",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "################################",
    ],
    [
      "################################",
      "#..............................#",
      "#........H.....................#",
      "#.......####...................#",
      "#..................H...........#",
      "#...............####...........#",
      "#...........A A A..............#",
      "#..............................#",
      "#....B.........................#",
      "#..S.......................D...#",
      "################################",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "################################",
    ],
    [
      "################################",
      "#..............................#",
      "#.............H................#",
      "#...........######.............#",
      "#......................H.......#",
      "#...................######.....#",
      "#..........A A A...............#",
      "#..............................#",
      "#....B.........................#",
      "#..S.......................D...#",
      "################################",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "################################",
    ],
    [
      "################################",
      "#..............................#",
      "#........H.....................#",
      "#.......####...................#",
      "#..............................#",
      "#...........A A A..............#",
      "#..............................#",
      "#......................H.......#",
      "#.................####.........#",
      "#..S........B..............D...#",
      "################################",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "################################",
    ],
    [
      "################################",
      "#..............................#",
      "#.............H................#",
      "#...........######.............#",
      "#..............................#",
      "#....B.........A A A...........#",
      "#..............................#",
      "#......................H.......#",
      "#...................######.....#",
      "#..S.......................D...#",
      "################################",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "#..............................#",
      "################################",
    ],
  ];

  let levelIndex = 0;
  let grid = [];
  let needHearts = 0;
  let gotHearts = 0;

  const keys = { left:false, right:false, jumpHeld:false, jumpPressed:false };

  // touch
  const leftBtn = document.getElementById("left");
  const rightBtn = document.getElementById("right");
  const jumpBtn = document.getElementById("jump");

  function hold(btn, down, up){
    const start = (e)=>{ e.preventDefault(); down(); };
    const end = (e)=>{ e.preventDefault(); up(); };
    btn.addEventListener("pointerdown", start);
    btn.addEventListener("pointerup", end);
    btn.addEventListener("pointercancel", end);
    btn.addEventListener("pointerleave", end);
  }
  hold(leftBtn, ()=>keys.left=true, ()=>keys.left=false);
  hold(rightBtn, ()=>keys.right=true, ()=>keys.right=false);
  hold(jumpBtn, ()=>{
    keys.jumpHeld = true;
    keys.jumpPressed = true;
  }, ()=>{ keys.jumpHeld = false; });

  // keyboard
  window.addEventListener("keydown", (e)=>{
    if(e.key==="ArrowLeft") keys.left=true;
    if(e.key==="ArrowRight") keys.right=true;
    if(e.key===" " || e.key==="ArrowUp"){
      if(!keys.jumpHeld) keys.jumpPressed = true;
      keys.jumpHeld = true;
    }
    if(e.key.toLowerCase()==="r") loadLevel(levelIndex);
  });
  window.addEventListener("keyup", (e)=>{
    if(e.key==="ArrowLeft") keys.left=false;
    if(e.key==="ArrowRight") keys.right=false;
    if(e.key===" " || e.key==="ArrowUp") keys.jumpHeld=false;
  });

  // UI
  document.getElementById("prev").addEventListener("click", ()=> loadLevel(Math.max(0, levelIndex-1)));
  document.getElementById("next").addEventListener("click", ()=> loadLevel(Math.min(LEVELS.length-1, levelIndex+1)));
  document.getElementById("restart").addEventListener("click", ()=> loadLevel(levelIndex));
  document.getElementById("reset").addEventListener("click", ()=> loadLevel(levelIndex));

  // fullscreen (wrap Ã¼stÃ¼nden)
  document.getElementById("fs").addEventListener("click", async ()=>{
    try{
      if(!document.fullscreenElement){
        await wrap.requestFullscreen();
        wrap.classList.add("fs-on");
      }else{
        await document.exitFullscreen();
        wrap.classList.remove("fs-on");
      }
    }catch{}
    setTimeout(()=>{ setVH(); fitCanvas(); }, 250);
  });
  document.addEventListener("fullscreenchange", ()=>{
    if(!document.fullscreenElement) wrap.classList.remove("fs-on");
    setTimeout(()=>{ setVH(); fitCanvas(); }, 250);
  });

  const player = {
    x: 0, y: 0, w: 18, h: 22,
    vx: 0, vy: 0,
    onGround:false,
    alive:true,
    coyote:0,
    jumpBoost:0
  };

  function parseLevel(lines){
    grid = lines.map(line=> line.split(""));
    needHearts = 0; gotHearts = 0;

    for(let y=0;y<ROWS;y++){
      for(let x=0;x<COLS;x++){
        const ch = grid[y][x];
        if(ch==="H") needHearts++;
        if(ch==="S"){
          player.x = x*TILE + 6;
          player.y = y*TILE + 4;
          grid[y][x]=".";
        }
      }
    }
    needEl.textContent = needHearts;
    heartsEl.textContent = gotHearts;
  }

  function loadLevel(i){
    levelIndex = i;
    lvlEl.textContent = (levelIndex+1);
    msgEl.textContent = messages[levelIndex] || "Elifâ€™imâ€¦ geÃ§ilebilir yaptÄ±m, sakin sakin ğŸ˜„ğŸ’—";

    hintEl.textContent = (levelIndex <= 1)
      ? "Ä°pucu: Kalpleri topla ğŸ’— â†’ kapÄ±ya git ğŸšª (Ã§ok kolay ğŸ˜„)"
      : (levelIndex <= 3)
        ? "Ä°pucu: YeÅŸil asit (A) Ã¶ldÃ¼rÃ¼r. ÃœstÃ¼nden zÄ±pla ğŸ§¸"
        : (levelIndex <= 5)
          ? "Ä°pucu: SarÄ± B = zÄ±plama taÅŸÄ±. Daha yÃ¼kseÄŸe Ã§Ä±kar âœ¨"
          : "Ä°pucu: Kalpleri tamamla, kapÄ± aÃ§Ä±lÄ±r ğŸ’—";

    parseLevel(LEVELS[levelIndex]);
    player.vx = player.vy = 0;
    player.onGround = false;
    player.alive = true;
    player.coyote = 0;
    player.jumpBoost = 0;

    fitCanvas();
  }

  function tileAt(px, py){
    const tx = Math.floor(px / TILE);
    const ty = Math.floor(py / TILE);
    if(ty<0||ty>=ROWS||tx<0||tx>=COLS) return "#";
    return grid[ty][tx];
  }
  function isSolid(ch){ return ch==="#"; }

  function rectVsRect(a,b){
    return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y;
  }

  function collide(axis){
    const pl = player;
    const pts = [
      {x: pl.x, y: pl.y},
      {x: pl.x+pl.w, y: pl.y},
      {x: pl.x, y: pl.y+pl.h},
      {x: pl.x+pl.w, y: pl.y+pl.h},
    ];
    for(const p of pts){
      const ch = tileAt(p.x, p.y);
      if(isSolid(ch)){
        const tx = Math.floor(p.x / TILE);
        const ty = Math.floor(p.y / TILE);
        const tileRect = { x:tx*TILE, y:ty*TILE, w:TILE, h:TILE };
        const pr = { x:pl.x, y:pl.y, w:pl.w, h:pl.h };

        if(rectVsRect(pr, tileRect)){
          if(axis==="x"){
            if(pl.vx>0) pl.x = tileRect.x - pl.w - 0.01;
            if(pl.vx<0) pl.x = tileRect.x + tileRect.w + 0.01;
            pl.vx = 0;
          }else{
            if(pl.vy>0){
              pl.y = tileRect.y - pl.h - 0.01;
              pl.vy = 0;
              pl.onGround = true;
            }
            if(pl.vy<0){
              pl.y = tileRect.y + tileRect.h + 0.01;
              pl.vy = 0;
            }
          }
        }
      }
    }
  }

  function interact(){
    const cx = player.x + player.w/2;
    const cy = player.y + player.h/2;
    const tx = Math.floor(cx / TILE);
    const ty = Math.floor(cy / TILE);
    const ch = grid[ty]?.[tx];

    if(ch==="A"){ player.alive=false; return; }

    if(ch==="B" && player.onGround){
      player.vy = -11.2;
      player.onGround = false;
      player.jumpBoost = 6;
    }

    if(ch==="H"){
      grid[ty][tx]=".";
      gotHearts++;
      heartsEl.textContent = gotHearts;
    }

    if(ch==="D"){
      if(gotHearts >= needHearts){
        if(levelIndex < LEVELS.length-1) loadLevel(levelIndex+1);
        else msgEl.textContent = "Bitti ğŸ˜„ Elifâ€™imâ€™e kocaman sarÄ±lma Ã¶dÃ¼lÃ¼ ğŸ’—";
      }else{
        msgEl.textContent = "KapÄ± aÃ§Ä±lmadÄ± ğŸ˜„ Ã–nce kalpler ğŸ’—";
      }
    }
  }

  function drawWallpaper(){
    const w = wallpapers[levelIndex % wallpapers.length];
    const g = ctx.createLinearGradient(0,0,LOG_W,LOG_H);
    g.addColorStop(0, w[0]);
    g.addColorStop(0.5, w[1]);
    g.addColorStop(1, w[2]);
    ctx.fillStyle = g;
    ctx.fillRect(0,0,LOG_W,LOG_H);

    ctx.fillStyle = "#ffffff12";
    for(let i=0;i<24;i++){
      const x = (i*43 + levelIndex*17) % LOG_W;
      const y = (i*29 + levelIndex*31) % LOG_H;
      ctx.beginPath();
      ctx.arc(x, y, 1.6, 0, Math.PI*2);
      ctx.fill();
    }
  }

  function step(){
    if(!player.alive){
      draw();
      requestAnimationFrame(step);
      return;
    }

    // kontrollÃ¼ fizik
    const speed = 1.85;
    const gravity = 0.31;
    const jumpV = 9.2;
    const maxFall = 10;

    if(player.onGround) player.coyote = 6;
    else player.coyote = Math.max(0, player.coyote - 1);

    player.vx = 0;
    if(keys.left) player.vx = -speed;
    if(keys.right) player.vx = speed;

    if(keys.jumpPressed && player.coyote > 0){
      player.vy = -jumpV;
      player.onGround = false;
      player.coyote = 0;
      player.jumpBoost = 10;
    }
    keys.jumpPressed = false;

    if(keys.jumpHeld && player.jumpBoost > 0){
      player.vy -= 0.22;
      player.jumpBoost--;
    } else {
      player.jumpBoost = Math.max(0, player.jumpBoost - 1);
    }

    player.vy += gravity;
    player.vy = Math.min(player.vy, maxFall);

    player.x += player.vx; collide("x");
    player.y += player.vy;
    player.onGround = false;
    collide("y");

    interact();
    draw();
    requestAnimationFrame(step);
  }

  function draw(){
    // LOG sahneyi Ã§iziyoruz (fitCanvas ctx transform ile Ã¶lÃ§ekliyor)
    drawWallpaper();

    // tiles
    for(let y=0;y<ROWS;y++){
      for(let x=0;x<COLS;x++){
        const ch = grid[y][x];
        if(ch==="." ) continue;

        if(ch==="#"){
          ctx.fillStyle = colors.wall;
          ctx.fillRect(x*TILE, y*TILE, TILE, TILE);
        }
        if(ch==="A"){
          ctx.fillStyle = colors.acid;
          ctx.fillRect(x*TILE, y*TILE, TILE, TILE);
          ctx.fillStyle = "#ffffff55";
          ctx.beginPath(); ctx.arc(x*TILE+10, y*TILE+12, 3, 0, Math.PI*2); ctx.fill();
          ctx.beginPath(); ctx.arc(x*TILE+18, y*TILE+18, 2, 0, Math.PI*2); ctx.fill();
        }
        if(ch==="B"){
          ctx.fillStyle = colors.bounce;
          ctx.fillRect(x*TILE, y*TILE, TILE, TILE);
          ctx.fillStyle = "#2b1d0088";
          ctx.fillRect(x*TILE+6, y*TILE+8, TILE-12, 4);
        }
        if(ch==="H"){
          ctx.fillStyle = colors.heart;
          const cx = x*TILE + 15, cy = y*TILE + 15;
          ctx.beginPath();
          ctx.moveTo(cx, cy+6);
          ctx.bezierCurveTo(cx-10, cy-2, cx-10, cy+12, cx, cy+14);
          ctx.bezierCurveTo(cx+10, cy+12, cx+10, cy-2, cx, cy+6);
          ctx.fill();
        }
        if(ch==="D"){
          ctx.fillStyle = colors.door;
          ctx.fillRect(x*TILE+6, y*TILE+4, TILE-12, TILE-8);
          ctx.fillStyle = (gotHearts < needHearts) ? "#ffffff55" : "#ffffffcc";
          ctx.fillRect(x*TILE+13, y*TILE+16, 4, 6);
        }
      }
    }

    // player (minnoÅŸ kedi)
    const pl = player;
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(pl.x, pl.y, pl.w, pl.h);

    // ears
    ctx.fillRect(pl.x+1, pl.y-4, 6, 6);
    ctx.fillRect(pl.x+pl.w-7, pl.y-4, 6, 6);

    // eyes
    ctx.fillStyle = "#111";
    ctx.fillRect(pl.x+4, pl.y+8, 3, 3);
    ctx.fillRect(pl.x+pl.w-7, pl.y+8, 3, 3);

    // blush
    ctx.fillStyle = "#ff7a9c";
    ctx.fillRect(pl.x+3, pl.y+12, 3, 2);
    ctx.fillRect(pl.x+pl.w-6, pl.y+12, 3, 2);

    // bow
    ctx.fillStyle = "#ff4d6d";
    ctx.fillRect(pl.x+pl.w-8, pl.y-2, 3, 3);
    ctx.fillRect(pl.x+pl.w-5, pl.y-3, 3, 3);
    ctx.fillRect(pl.x+pl.w-5, pl.y, 3, 3);

    if(!pl.alive){
      ctx.fillStyle = "#000000aa";
      ctx.fillRect(0,0,LOG_W,LOG_H);
      ctx.fillStyle = "#ffffff";
      ctx.font = "900 22px ui-rounded, system-ui";
      ctx.fillText("Ayy ğŸ˜„ Asit olduâ€¦", 24, 60);
      ctx.font = "800 14px ui-rounded, system-ui";
      ctx.fillStyle = "#ffffffcc";
      ctx.fillText("SÄ±fÄ±rlaâ€™ya bas (ya da R). Elifâ€™im Ã¼zÃ¼lmesin ğŸ§¸ğŸ’—", 24, 88);
    }
  }

  // init
  loadLevel(0);
  step();
})();
</script>
</body>
</html>
